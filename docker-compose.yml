version: '3.8'

services:
  minecraft-server:
    # Use official OpenJDK image with Java 21
    image: openjdk:21-jdk-slim
    
    # Container name
    container_name: minecraft-fabric-server
    
    # Restart policy
    restart: unless-stopped
    
    # Working directory inside container
    working_dir: /server
    
    # Command to run the server
    command: >
      bash -c "
        echo 'Starting Minecraft Fabric Server...' &&
        java -Xms2G -Xmx4G 
        -XX:+UseG1GC 
        -XX:+ParallelRefProcEnabled 
        -XX:MaxGCPauseMillis=200 
        -XX:+UnlockExperimentalVMOptions 
        -XX:+DisableExplicitGC 
        -XX:+AlwaysPreTouch 
        -XX:G1NewSizePercent=30 
        -XX:G1MaxNewSizePercent=40 
        -XX:G1HeapRegionSize=8M 
        -XX:G1ReservePercent=20 
        -XX:G1HeapWastePercent=5 
        -XX:G1MixedGCCountTarget=4 
        -XX:InitiatingHeapOccupancyPercent=15 
        -XX:G1MixedGCLiveThresholdPercent=90 
        -XX:G1RSetUpdatingPauseTimePercent=5 
        -XX:SurvivorRatio=32 
        -XX:+PerfDisableSharedMem 
        -XX:MaxTenuringThreshold=1 
        -jar fabric-server-launcher.jar --nogui
      "
    
    # Port mappings
    ports:
      - "25565:25565"  # Java Edition
      - "19132:19132/udp"  # Bedrock Edition
    
    # Volume mappings
    volumes:
      # Server files
      - ./:/server
      # Persistent world data
      - minecraft-world:/server/world
      - minecraft-world-nether:/server/world_nether
      - minecraft-world-end:/server/world_the_end
      # Logs
      - minecraft-logs:/server/logs
      # Cache
      - minecraft-cache:/server/.cache
    
    # Environment variables
    environment:
      # JVM settings
      - JAVA_OPTS=-Xms2G -Xmx4G
      
      # Server settings
      - SERVER_PORT=25565
      - BEDROCK_PORT=19132
      - MAX_PLAYERS=20
      - DIFFICULTY=normal
      - GAMEMODE=survival
      
      # Docker specific
      - DOCKER_CONTAINER=true
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 5G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    
    # Health check
    healthcheck:
      test: ["CMD", "ss", "-ln", "|", "grep", ":25565"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    # Network settings
    network_mode: "host"  # For better performance and easier port management

# Named volumes for persistence
volumes:
  minecraft-world:
    driver: local
  minecraft-world-nether:
    driver: local
  minecraft-world-end:
    driver: local
  minecraft-logs:
    driver: local
  minecraft-cache:
    driver: local